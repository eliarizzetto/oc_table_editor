{% extends "base.html" %}

{% block title %}OC Table Editor - {{ session_id[:8] }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar controls -->
    <div class="col-md-2 sidebar-container" id="sidebarContainer">
        <button class="sidebar-toggle" id="sidebarToggle" title="Collapse sidebar">
            Â«
        </button>
        <div id="sidebarContent">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Actions</h6>
            </div>
            <div class="card-body p-2">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" id="revalidateBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        Re-Validate
                    </button>
                    <button class="btn btn-success btn-sm" id="exportBtn">
                        Export CSV
                    </button>
                    <button class="btn btn-secondary btn-sm" id="saveDraftBtn">
                        Save Draft
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="deleteDraftBtn">
                        Delete Draft
                    </button>
                </div>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-outline-secondary btn-sm flex-fill" id="undoBtn" disabled title="Undo (Ctrl+Z)">
                        â†© Undo
                    </button>
                    <button class="btn btn-outline-secondary btn-sm flex-fill" id="redoBtn" disabled title="Redo (Ctrl+Y)">
                        â†ª Redo
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Session Info</h6>
            </div>
            <div class="card-body p-2">
                <p class="mb-1 small"><strong>Session:</strong> <span id="sessionId">{{ session_id[:8] }}</span></p>
                <p class="mb-1 small"><strong>Edited Items:</strong> <span id="editedCount">0</span></p>
                <p class="mb-1 small" id="editedSinceValContainer">
                    <strong>Edits Since Validation:</strong> 
                    <span id="editedSinceVal">No</span>
                </p>
                <p class="mb-1 small"><strong>Last Validated:</strong> <span id="lastValidated">-</span></p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Tips</h6>
            </div>
            <div class="card-body p-2 small">
                <ul class="mb-0 ps-3">
                    <li>Click on any text to edit it</li>
                    <li>Hover on cells to see action buttons (add, clear, delete)</li>
                    <li>Use <em>+ add</em> to append a new value to multi-value fields</li>
                    <li>Grey background = edited item</li>
                    <li>Underline = has validation issues</li>
                    <li>Click colored square to filter by issue</li>
                    <li>Re-validate after editing</li>
                </ul>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Main editor area -->
    <div class="col-md-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Validation Results</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="showAllBtn">Show All</button>
                    <button class="btn btn-sm btn-outline-secondary" id="showEditedBtn">Show Edited</button>
                </div>
            </div>
            <!-- Filter banner (hidden by default) -->
            <div id="filterBanner" class="filter-banner" style="display: none;"></div>
            <div class="card-body" id="tableContainer">
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading table...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Current Value:</label>
                <p class="form-control-plaintext" id="currentValue"></p>
                
                <label class="form-label" for="newValue">New Value:</label>
                <input type="text" class="form-control" id="newValue" placeholder="Enter new value">
                
                <div class="form-text" id="itemInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm me-auto" id="deleteItemBtn" title="Delete this specific item">
                    ðŸ—‘ Delete this item
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add item modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label" for="newItemValue">Value:</label>
                <input type="text" class="form-control" id="newItemValue" placeholder="Enter value">
                
                <div class="form-text" id="addItemInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewItemBtn">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="alertTitle"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="alertMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Make sessionId globally accessible for editor.js
window.currentSessionId = '{{ session_id }}';
const sessionId = '{{ session_id }}';
let currentItemId = null;
let editModal = null;
let addItemModal = null;
let alertToast = null;
let currentAddRowId = null;
let currentAddFieldName = null;

document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));
    alertToast = new bootstrap.Toast(document.getElementById('alertToast'));
    
    // Load initial data
    loadTable();
    loadSessionInfo();
    
    // Event listeners
    document.getElementById('revalidateBtn').addEventListener('click', revalidate);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
    document.getElementById('deleteDraftBtn').addEventListener('click', deleteDraft);
    document.getElementById('showAllBtn').addEventListener('click', () => loadTable());
    document.getElementById('showEditedBtn').addEventListener('click', loadEditedOnly);
    document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
    document.getElementById('deleteItemBtn').addEventListener('click', () => deleteItem(currentItemId));
    document.getElementById('saveNewItemBtn').addEventListener('click', saveNewItem);
    document.getElementById('undoBtn').addEventListener('click', undoEdit);
    document.getElementById('redoBtn').addEventListener('click', redoEdit);

    // â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Only intercept when no text-input / textarea has focus (so that the
    // browser's native Ctrl+Z inside the modal text box keeps working).
    document.addEventListener('keydown', function(e) {
        const tag = document.activeElement && document.activeElement.tagName;
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

        if (e.ctrlKey && !e.shiftKey && e.key === 'z') {
            e.preventDefault();
            undoEdit();
        } else if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
            e.preventDefault();
            redoEdit();
        }
    });

    // Load initial undo/redo button state
    updateUndoRedoButtons();
    
    // Sidebar toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebarContainer');
        const toggleBtn = document.getElementById('sidebarToggle');
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) {
            toggleBtn.textContent = 'Â»';
            toggleBtn.title = 'Expand sidebar';
        } else {
            toggleBtn.textContent = 'Â«';
            toggleBtn.title = 'Collapse sidebar';
        }
    });
});

async function loadTable() {
    const container = document.getElementById('tableContainer');
    
    // Exit filtered view when loading full table
    if (typeof exitFilteredView === 'function') {
        exitFilteredView();
    }
    
    try {
        const response = await fetch(`/api/edit/html/${sessionId}`);
        const data = await response.json();
        
        if (response.ok) {
            container.innerHTML = data.html;
            setupEditHandlers();
            initBootstrapWidgets();
        } else {
            throw new Error(data.detail || 'Failed to load table');
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

async function loadEditedOnly() {
    const container = document.getElementById('tableContainer');
    
    try {
        const response = await fetch(`/api/edit/session/${sessionId}`);
        const sessionData = await response.json();
        
        if (!response.ok) throw new Error('Failed to load session');
        
        // Get HTML and filter for edited items
        const htmlResponse = await fetch(`/api/edit/html/${sessionId}`);
        const htmlData = await htmlResponse.json();
        
        if (!htmlResponse.ok) throw new Error('Failed to load HTML');
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlData.html, 'text/html');
        const table = doc.getElementById('table-data');
        
        if (!table) throw new Error('Table not found');
        
        // Filter rows to show only edited items
        const tbody = table.querySelector('tbody');
        const editedItemIds = new Set();
        
        // Get edited items from session
        const editStateResponse = await fetch('/api/edit/edited/' + sessionId);
        if (editStateResponse.ok) {
            const editData = await editStateResponse.json();
            editData.edited_items.forEach(item => editedItemIds.add(item.item_id));
        }
        
        if (editedItemIds.size === 0) {
            showAlert('info', 'No Edits', 'No items have been edited yet.');
            return;
        }
        
        // Filter rows containing edited items
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(row => {
            const editedSpan = row.querySelector('.item-data.edited');
            if (!editedSpan) {
                row.style.display = 'none';
            }
        });
        
        container.innerHTML = doc.body.innerHTML;
        setupEditHandlers();
        initBootstrapWidgets();
        
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function loadSessionInfo() {
    try {
        const response = await fetch(`/api/edit/session/${sessionId}`);
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('editedCount').textContent = data.edited_items_count;
            document.getElementById('editedSinceVal').textContent = data.has_edits_since_validation ? 'Yes' : 'No';
            document.getElementById('lastValidated').textContent = data.last_validated_at 
                ? new Date(data.last_validated_at).toLocaleString() 
                : '-';
        }
    } catch (error) {
        console.error('Error loading session info:', error);
    }
}

function setupEditHandlers() {
    // 1. Mark empty .item-data spans with .empty-slot for CSS styling
    document.querySelectorAll('.item-data').forEach(span => {
        if (span.textContent.trim() === '') {
            span.classList.add('empty-slot');
        }
    });

    // 2. Attach click handlers to all .item-data spans (non-issue-icon clicks)
    document.querySelectorAll('.item-data').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.classList.contains('issue-icon')) return;
            e.stopPropagation();
            e.preventDefault();
            const container = this.closest('.item-container');
            if (!container || !container.id) return;
            currentItemId = container.id;
            openEditModal(this.textContent, currentItemId);
        });
        item.style.cursor = 'pointer';
    });

    // 3. Inject delete-row buttons into row-number cells (visible on row hover)
    document.querySelectorAll('td.row-number').forEach(cell => {
        const row = cell.closest('tr');
        if (!row || !row.id) return;
        const rowId = row.id;
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-outline-danger delete-row-btn';
        delBtn.title = 'Delete this entire row';
        delBtn.textContent = 'Ã—';
        delBtn.addEventListener('click', e => { e.stopPropagation(); deleteRow(rowId); });
        cell.appendChild(delBtn);
    });

    // 4. Inject clear-cell buttons and add-item buttons
    document.querySelectorAll('td.field-value').forEach(cell => {
        const classes = Array.from(cell.classList);
        const fvIdx = classes.indexOf('field-value');
        const fieldName = (fvIdx >= 0 && fvIdx + 1 < classes.length) ? classes[fvIdx + 1] : null;
        if (!fieldName) return;
        const row = cell.closest('tr');
        if (!row || !row.id) return;
        const rowId = row.id;

        // "âœ• clear" button â€” revealed on cell hover via CSS
        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn btn-outline-secondary clear-cell-btn';
        clearBtn.title = `Clear all values in "${fieldName}"`;
        clearBtn.textContent = 'âœ• clear';
        clearBtn.addEventListener('click', e => { e.stopPropagation(); clearCell(rowId, fieldName); });
        cell.appendChild(clearBtn);

        // For multi-value fields, inject an add-item button after the last item
        if (MULTI_VALUE_FIELDS.has(fieldName)) {
            const containers = cell.querySelectorAll('.item-container');
            
            // For empty multi-value cells, inject a small "add first value" button
            if (containers.length === 0) {
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-sm btn-outline-secondary add-first-item-btn';
                addBtn.textContent = '+ add value';
                addBtn.addEventListener('click', e => { e.stopPropagation(); initCell(rowId, fieldName); });
                cell.insertBefore(addBtn, clearBtn);
            } else {
                // For cells with items, inject add-item button after the last item
                const lastContainer = containers[containers.length - 1];
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-sm btn-outline-secondary add-item-btn';
                addBtn.textContent = '+ add';
                addBtn.title = 'Add another item to this field';
                addBtn.addEventListener('click', e => { 
                    e.stopPropagation(); 
                    openAddItemModal(rowId, fieldName);
                });
                cell.insertBefore(addBtn, clearBtn);
            }
        }
    });
}

// Multi-value fields (must match HTMLParser.ITEM_SEPARATORS in html_parser.py)
const MULTI_VALUE_FIELDS = new Set(['citing_id', 'cited_id', 'id', 'author', 'publisher', 'editor']);

/**
 * Parse the field name from an item_id string.
 * item_id format: "{row}-{field}-{index}"  (field may contain hyphens, e.g. "citing_id")
 * Everything between the first and last "-" component is the field name.
 */
function fieldNameFromItemId(itemId) {
    const parts = itemId.split('-');
    if (parts.length < 3) return null;
    return parts.slice(1, -1).join('-');
}

function openEditModal(currentValue, itemId) {
    document.getElementById('currentValue').textContent = currentValue;
    document.getElementById('newValue').value = currentValue;
    document.getElementById('itemInfo').textContent = `Item ID: ${itemId}`;
    editModal.show();
}

function openAddItemModal(rowId, fieldName) {
    currentAddRowId = rowId;
    currentAddFieldName = fieldName;
    document.getElementById('newItemValue').value = '';
    document.getElementById('addItemInfo').textContent = `Adding item to field "${fieldName}" in row ${rowId}`;
    addItemModal.show();
}

async function saveNewItem() {
    const newValue = document.getElementById('newItemValue').value.trim();
    
    // Validate that value is not empty
    if (!newValue) {
        showAlert('warning', 'Value Required', 'Please enter a value to add. Empty items are not allowed.');
        return;
    }
    
    try {
        const response = await fetch('/api/edit/item/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                row_id: currentAddRowId,
                field_name: currentAddFieldName,
                new_value: newValue
            })
        });

        const data = await response.json();

        if (response.ok) {
            addItemModal.hide();
            showAlert('success', 'Item Added', 'The new item has been added to the field.');
            updateUndoRedoButtons();
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to add item');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function deleteItem(itemId) {
    if (!confirm(`Delete this item? This will remove only this specific item from the field.`)) return;
    
    try {
        const response = await fetch('/api/edit/item', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                item_id: itemId
            })
        });

        const data = await response.json();

        if (response.ok) {
            editModal.hide();
            showAlert('success', 'Item Deleted', 'The item has been removed from the field.');
            updateUndoRedoButtons();
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to delete item');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function deleteRow(rowId) {
    if (!confirm(`Delete the entire row? All data in this row will be permanently removed from the table.`)) return;
    try {
        const response = await fetch('/api/edit/row/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, row_id: rowId })
        });
        const data = await response.json();
        if (response.ok) {
            editModal.hide();
            showAlert('success', 'Row Deleted', 'The row has been removed from the table.');
            updateUndoRedoButtons();
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to delete row');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function clearCell(rowId, fieldName) {
    if (!confirm(`Clear all values in the "${fieldName}" field for this row?`)) return;
    try {
        const response = await fetch('/api/edit/cell/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, row_id: rowId, field_name: fieldName })
        });
        const data = await response.json();
        if (response.ok) {
            editModal.hide();
            showAlert('success', 'Field Cleared', `The "${fieldName}" field has been cleared.`);
            updateUndoRedoButtons();
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to clear field');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function initCell(rowId, fieldName) {
    // Initialise an empty multi-value cell so it becomes clickable
    try {
        const response = await fetch('/api/edit/cell/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, row_id: rowId, field_name: fieldName })
        });
        const data = await response.json();
        if (response.ok) {
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to initialize cell');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function addItemToCell(itemId) {
    try {
        const response = await fetch('/api/edit/item/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                item_id: itemId
            })
        });

        const data = await response.json();

        if (response.ok) {
            editModal.hide();
            showAlert('success', 'Item Added', 'A new empty slot has been added. Click it to enter a value.');
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to add item');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function saveEdit() {
    const newValue = document.getElementById('newValue').value;
    
    try {
        const response = await fetch('/api/edit/item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                item_id: currentItemId,
                new_value: newValue
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('success', 'Saved', 'Item updated successfully!');
            editModal.hide();
            updateUndoRedoButtons();
            reloadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Failed to save');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function revalidate() {
    const btn = document.getElementById('revalidateBtn');
    const spinner = btn.querySelector('.spinner-border');
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/edit/revalidate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('success', 'Validation Complete', `Found ${data.error_count} errors/warnings.`);
            loadTable();
            loadSessionInfo();
        } else {
            throw new Error(data.detail || 'Validation failed');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
    }
}

async function exportCSV() {
    try {
        const response = await fetch('/api/export/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                revalidate: false
            })
        });
        
        if (response.ok) {
            // Handle CSV download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exported_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'Export failed');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function saveDraft() {
    try {
        const response = await fetch('/api/draft/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('success', 'Saved', data.message);
        } else {
            throw new Error(data.detail || 'Failed to save');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function deleteDraft() {
    if (!confirm('Are you sure you want to delete this draft?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/draft/${sessionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('success', 'Deleted', 'Draft deleted successfully.');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            throw new Error('Failed to delete draft');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

// â”€â”€ Undo / Redo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateUndoRedoButtons(canUndo, canRedo) {
    // If called without arguments, fetch the state from the server
    if (canUndo === undefined) {
        fetch(`/api/edit/undo_state/${sessionId}`)
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(d => {
                document.getElementById('undoBtn').disabled = !d.can_undo;
                document.getElementById('redoBtn').disabled = !d.can_redo;
            })
            .catch(() => {});
        return;
    }
    document.getElementById('undoBtn').disabled = !canUndo;
    document.getElementById('redoBtn').disabled = !canRedo;
}

async function undoEdit() {
    try {
        const response = await fetch('/api/edit/undo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });
        const data = await response.json();
        if (response.ok) {
            if (data.success) {
                updateUndoRedoButtons(data.can_undo, data.can_redo);
                reloadTable();
                loadSessionInfo();
            } else {
                showAlert('info', 'Undo', data.message || 'Nothing to undo.');
            }
        } else {
            throw new Error(data.detail || 'Undo failed');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

async function redoEdit() {
    try {
        const response = await fetch('/api/edit/redo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });
        const data = await response.json();
        if (response.ok) {
            if (data.success) {
                updateUndoRedoButtons(data.can_undo, data.can_redo);
                reloadTable();
                loadSessionInfo();
            } else {
                showAlert('info', 'Redo', data.message || 'Nothing to redo.');
            }
        } else {
            throw new Error(data.detail || 'Redo failed');
        }
    } catch (error) {
        showAlert('error', 'Error', error.message);
    }
}

function showAlert(type, title, message) {
    const titleEl = document.getElementById('alertTitle');
    const messageEl = document.getElementById('alertMessage');
    const toast = document.getElementById('alertToast');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    toast.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-info', 'text-bg-warning');
    
    switch(type) {
        case 'success':
            toast.classList.add('text-bg-success');
            break;
        case 'error':
            toast.classList.add('text-bg-danger');
            break;
        case 'info':
            toast.classList.add('text-bg-info');
            break;
        case 'warning':
            toast.classList.add('text-bg-warning');
            break;
    }
    
    alertToast.show();
}
</script>
{% endblock %}